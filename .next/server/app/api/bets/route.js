"use strict";(()=>{var e={};e.id=503,e.ids=[503],e.modules={53524:e=>{e.exports=require("@prisma/client")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},58378:(e,t,a)=>{a.r(t),a.d(t,{headerHooks:()=>C,originalPathname:()=>S,patchFetch:()=>_,requestAsyncStorage:()=>p,routeModule:()=>A,serverHooks:()=>T,staticGenerationAsyncStorage:()=>h,staticGenerationBailout:()=>P});var r={};a.r(r),a.d(r,{GET:()=>E,POST:()=>c});var s=a(95419),n=a(69108),o=a(99678),i=a(78070),d=a(3214),l=a(41209),u=a(63235);async function c(e){try{let t;let{challengeAccountId:a,marketId:r,selection:s,stake:n}=await e.json();if(!a||!r||!s||!n)return i.Z.json({error:"Missing required fields"},{status:400});let o=await d._.market.findUnique({where:{id:r},include:{oddsSnapshots:{orderBy:{ts:"desc"},take:1}}});if(!o)return i.Z.json({error:"Market not found"},{status:404});if(!o.oddsSnapshots[0])return i.Z.json({error:"No odds available for this market"},{status:400});let c=o.oddsSnapshots[0],E=c.lineJSON;if("MONEYLINE"===o.marketType)t=s===o.participants[0]?E.home:E.away;else if("SPREAD"===o.marketType)t=s.includes("home")?E.home.odds:E.away.odds;else{if("TOTAL"!==o.marketType)return i.Z.json({error:"Unsupported market type"},{status:400});t=s.includes("over")?E.over.odds:E.under.odds}let A=await (0,l.cI)(a,n,o.marketType,t);if(!A.valid)return i.Z.json({error:"Bet validation failed",details:A.errors},{status:400});let p=(0,l.f9)(n,t),h=await d._.bet.create({data:{challengeAccountId:a,marketId:r,oddsSnapshotId:c.id,selection:s,stake:n,potentialPayout:p,status:"OPEN"},include:{market:!0,oddsSnapshot:!0}});return await (0,u.U)({userId:a,action:u.A.BET_PLACED,payload:{betId:h.id,marketId:h.marketId,selection:h.selection,stake:h.stake,potentialPayout:h.potentialPayout,odds:t}}),i.Z.json({bet:h},{status:201})}catch(e){return console.error("Bet creation error:",e),i.Z.json({error:"Internal server error"},{status:500})}}async function E(e){try{let{searchParams:t}=new URL(e.url),a=t.get("challengeAccountId"),r=t.get("status");if(!a)return i.Z.json({error:"challengeAccountId is required"},{status:400});let s={challengeAccountId:a};r&&(s.status=r);let n=await d._.bet.findMany({where:s,include:{market:!0,oddsSnapshot:!0,settlements:!0},orderBy:{placedAt:"desc"}});return i.Z.json({bets:n})}catch(e){return console.error("Bets fetch error:",e),i.Z.json({error:"Internal server error"},{status:500})}}let A=new s.AppRouteRouteModule({definition:{kind:n.x.APP_ROUTE,page:"/api/bets/route",pathname:"/api/bets",filename:"route",bundlePath:"app/api/bets/route"},resolvedPagePath:"/Users/samirkassam/Desktop/PP2/profitplay/app/api/bets/route.ts",nextConfigOutput:"",userland:r}),{requestAsyncStorage:p,staticGenerationAsyncStorage:h,serverHooks:T,headerHooks:C,staticGenerationBailout:P}=A,S="/api/bets/route";function _(){return(0,o.patchFetch)({serverHooks:T,staticGenerationAsyncStorage:h})}},63235:(e,t,a)=>{a.d(t,{A:()=>n,U:()=>s});var r=a(3214);async function s(e){try{await r._.auditLog.create({data:{userId:e.userId,action:e.action,payload:e.payload,ip:e.ip}})}catch(e){console.error("Failed to create audit log:",e)}}let n={USER_SIGNUP:"USER_SIGNUP",USER_LOGIN:"USER_LOGIN",USER_LOGOUT:"USER_LOGOUT",SUBSCRIPTION_CREATED:"SUBSCRIPTION_CREATED",SUBSCRIPTION_UPDATED:"SUBSCRIPTION_UPDATED",SUBSCRIPTION_CANCELLED:"SUBSCRIPTION_CANCELLED",CHALLENGE_ACCOUNT_CREATED:"CHALLENGE_ACCOUNT_CREATED",CHALLENGE_ACCOUNT_UPDATED:"CHALLENGE_ACCOUNT_UPDATED",BET_PLACED:"BET_PLACED",BET_CANCELLED:"BET_CANCELLED",BET_SETTLED:"BET_SETTLED",RULE_VIOLATION:"RULE_VIOLATION",CHALLENGE_PASSED:"CHALLENGE_PASSED",CHALLENGE_FAILED:"CHALLENGE_FAILED",CHALLENGE_PAUSED:"CHALLENGE_PAUSED",ADMIN_ACTION:"ADMIN_ACTION",PAYOUT_REQUESTED:"PAYOUT_REQUESTED",PAYOUT_APPROVED:"PAYOUT_APPROVED",PAYOUT_REJECTED:"PAYOUT_REJECTED"}},3214:(e,t,a)=>{a.d(t,{_:()=>s});var r=a(53524);let s=globalThis.prisma??new r.PrismaClient},41209:(e,t,a)=>{a.d(t,{HJ:()=>n,Ti:()=>o,cI:()=>i,f9:()=>d,tq:()=>l});var r=a(3214),s=a(53524);async function n(e,t){let a;let n=await r._.challengeAccount.findUnique({where:{id:e},include:{ruleset:!0}});if(!n)throw Error("Challenge account not found");let o=[],i=t;if(void 0===i){let t=new Date;t.setHours(0,0,0,0);let a=new Date(t);a.setDate(a.getDate()+1),i=(await r._.bet.findMany({where:{challengeAccountId:e,settledAt:{gte:t,lt:a},status:{in:["WON","LOST","PUSH"]}}})).reduce((e,t)=>"WON"===t.status?e+(t.potentialPayout-t.stake):"LOST"===t.status?e-t.stake:e,0)}let d=n.ruleset,l=n.equity,u=n.startBalance,c=n.highWaterMark,E=d.maxDailyLossPct/100*u;i<-E&&(o.push(`Daily loss limit exceeded: $${Math.abs(i).toFixed(2)} > $${E.toFixed(2)}`),a=s.ChallengeState.PAUSED);let A=(c-l)/c;A>d.maxDrawdownPct/100&&(o.push(`Maximum drawdown exceeded: ${(100*A).toFixed(2)}% > ${d.maxDrawdownPct}%`),a=s.ChallengeState.FAILED);let p=d.profitTargetPct/100*u;if(l-u>=p&&0===o.length&&(a=s.ChallengeState.PASSED),d.consistencyRule&&d.consistencyPct){let e=l-u;if(e>0){let t=d.consistencyPct/100*e;i>t&&(o.push(`Consistency rule violated: single day profit $${i.toFixed(2)} > $${t.toFixed(2)}`),a=s.ChallengeState.PAUSED)}}return{passed:0===o.length,violations:o,newState:a}}async function o(e,t,a){let s={state:t,updatedAt:new Date};return a&&(s.completedAt=a),await r._.challengeAccount.update({where:{id:e},data:s})}async function i(e,t,a,n){let o=await r._.challengeAccount.findUnique({where:{id:e},include:{ruleset:!0}});if(!o)return{valid:!1,errors:["Challenge account not found"]};let i=[],d=o.ruleset;o.state!==s.ChallengeState.ACTIVE&&i.push("Challenge account is not active");let l=o.equity*(d.maxStakePct/100);return t>l&&i.push(`Stake exceeds maximum allowed: $${t.toFixed(2)} > $${l.toFixed(2)}`),d.allowedMarkets.includes(a)||i.push(`Market type '${a}' is not allowed for this plan`),d.maxOdds&&n>d.maxOdds&&i.push(`Odds exceed maximum allowed: ${n} > ${d.maxOdds}`),t>o.equity&&i.push("Insufficient balance for this stake"),{valid:0===i.length,errors:i}}function d(e,t){return t>0?t/100*e:100/Math.abs(t)*e}function l(e){switch(e.status){case"WON":return e.potentialPayout-e.stake;case"LOST":return-e.stake;default:return 0}}}};var t=require("../../../webpack-runtime.js");t.C(e);var a=e=>t(t.s=e),r=t.X(0,[638,206],()=>a(58378));module.exports=r})();